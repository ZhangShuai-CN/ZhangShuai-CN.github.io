---
layout:     post
title:      "I/O虚拟化 103：Intel 虚拟化技术（Intel® VT）概述"
subtitle:   "VT-x/VT-i、VT-d/IOMMU、VT-c、TXT、SR-IOV 与 MR-IOV 技术概述"
description: "A Deep Dive into Intel® Virtualization Technology: VT-x, VT-d/AMD® IOMMU, VT-c, TXT, SR-IOV and MR-IOV."
excerpt: ""
date:       2023-03-19 01:01:01
author:     "张帅"
image: "/img/2023-03-19-intel-vt/background.jpg"
showtoc: true
draft: true
tags:
    - VT-x
    - VT-c
    - VT-d
    - SR-IOV
categories: [ Tech ]
URL: "/2023/03/19/intel-vt/"
---

- - -
###### 关于作者
> 
> **`张帅，网络从业人员，公众号：Flowlet`**
> 
> **`个人博客：https://flowlet.net/`**
- - -

## 序言
- - -

虚拟化技术允许多个工作负载共享一组公共的硬件资源。Intel® VT 就是 Intel 平台上虚拟化技术（Virtualization Technology）的总称，本文对 Intel 涉及的虚拟化技术进行盘点并主要讲解 Intel I/O 相关的虚拟化技术。

## 前言
- - -

由于作者水平有限，本文不免存在遗漏或错误之处，欢迎指正交流。

## 1. Intel® VT 广义虚拟化技术
- - -

Intel® VT 提供的广义上的虚拟化技术主要包括以下几项：

### 1.1 CPU 虚拟化（VT-x/VT-i）
- - -

目前主要的 CPU 虚拟化技术是 Intel 的 VT-x/VT-i 和 AMD 的 AMD-V 这两种技术。

Intel CPU 虚拟化技术主要有 2 类：
* **VT-x**：用于 X86 架构的的 CPU 虚拟化技术（Intel Virtualization Technologyfor x86），主要是 IA-32 和 Intel 64 系列处理器。
* **VT-i**：用于安腾（Itanium）架构处理器的 CPU 虚拟化技术（Intel Virtualization Technology for ltanium），主要是 Itanium 系列处理器。

#### 1.1.1 CPU 指令分级
- - -

现代计算机的 CPU 技术有个核心特点，就是指令分级运行，这样做的目的是为了避免用户应用程序层面的错误导致整个系统的崩溃。不同类型的 CPU 会分成不同的级别，比如 IBM PowerPC 和 SUN SPARC 分为 Core 与 User 两个级别，MIPS 多了个 Supervisor 共三个级别。

![](/img/2023-03-19-intel-vt/2023-05-01-figure1.png)

本文针对的 X86 CPU 则分为 Ring0-Ring3 共 4 个级别，我们只需要关注特权级别（Ring 0）和用户级别（Ring1-Ring3）两个层面即可。

![](/img/2023-03-19-intel-vt/2023-05-02-figure2.svg)

对于非虚拟化的普通操作系统而言，Ring 0 是最高特权级别，拥有对物理内存和硬件 I/O 资源的直接访问控制权。Ring 1、2 和 3 权限依次降低，无法执行操作内核系统级别的指令集合，只拥有对于虚拟内存的直接访问控制权。相应的，运行于 Ring 0 的指令称为“特权指令”；运行于其他级别的称为“非特权指令”。

常见的操作系统如 Linux 与 Windows 都运行于 Ring 0，而用户级应用程序运行于 Ring 3。如果低特权级别的程序执行了特权指令，会引起“陷入”（Trap）内核态，并抛出一个异常。

#### 1.1.2 非 X86 平台的虚拟化

![](/img/2023-03-19-intel-vt/2023-05-02-figure3.png)

当这种分层隔离机制应用于虚拟化平台，为了满足 VMM 的“资源可控”的特征，VMM 必须处于 Ring 0 级别控制所有的硬件资源，并且执行最高特权系统调用。而虚拟机操作系统 Guest OS 则要被降级运行在 Ring 1 级别，Guest OS 的应用程序则运行在 Ring 3。

故 Guest OS 在执行特权指令时都会引起”陷入“。如果 VMM 能够正常捕获异常，模拟 Guest OS 发出的指令并执行，就达到了目的。大型服务器如 PowerPC 和 SPARC 架构的 CPU 运行在 RISC 指令集中，所有的敏感指令都属于特权指令。因此可以采用上面所说的特权解除和陷入模拟的机制完美的进行虚拟化实现。

![](/img/2023-03-19-intel-vt/2023-05-02-figure4.png)

但对于 X86 架构的 CISC 指令集而言，存在 19 条非特权指令的敏感指令，这些指令被  Guest OS 在 Ring1 级别执行时，会被直接执行，无法产生异常从而陷入 Ring0 处理，也就导致无法采用上面所说的经典技术进行虚拟化。

#### 1.1.3 X86 平台的虚拟化

x86 平台的指令集大致分为以下 4 类：
* **1. 访问或修改机器状态的指令**。
* **2. 访问或修改敏感寄存器或存储单元的指令， 比如访问时钟寄存器和中断寄存器**。
* **3. 访问存储保护系统或内存、地址分配系统的指令（段页之类）**。
* **4. 所有I/O指令**。

其中，第 1、4 类指令属于敏感指令中的特权指令，由操作系统内核执行，Guest O S在执行两类指令时，因为不处于 Ring 0 级别，所以会陷入，并抛出异常，这个异常会被 VMM 捕获，然后模拟 Gust OS 去执行，并将执行结果返回给 Guest OS。到此为止，一切都 OK。

但是，第 2、3 类指令属于非特权指令，可以由应用程序调用，也就是可以在 Ring 3 级别执行，并调用 Guest OS 内核进程来完成。当应用程序调用这些指令时，由于要修改内存和内部寄存器，这些状态修改需要由 Guest OS 完成，而 Guse OS 此时运行在 Ring 1 级别，虽然也会发生陷入，但是不会抛出异常，这样 VMM 就捕获不到，也就无法模拟完成。因此，当 Guest OS 执行这些指令就会导致虚拟机状态异常，甚至影响服务器的状态。在 x86 平台下，这类指令共有 19 个，我们称之为 x86 平台的敏感指令。

就是因为 x86 平台指令集有上述缺陷，所以为了计算虚拟化技术在 x86 平台应用，各大虚拟化厂商推出了五花八门的虚拟化技术，其目的都是围绕“如何捕获模拟这 19 条敏感指令”这一命题来设计。

在上述问题中，涉及到 3 个主要的对象，Guest OS、VMM 和硬件 CPU 的指令集，其中 VMM 是新插入的对象，修改起来最方便，但 OS 和 CPU 改起来就难一些。解决方案的思路也由此分为 3 个方向：
* **改动 VMM**：即 CPU 全虚拟化（CPU Full-Virtualization），优点是兼容性最强，OS 和 CPU 都无需改动，缺点是效率最低。
* **改动 OS**：即 CPU 半虚拟化（CPU Para-Virtualization），优点是相较于 CPU Full-Virtualization 效率有较大的提升，缺点是要改动 OS，因为 Windows 内核并不开源，只能基于 Linux 内核进行适配，而且会带来扩展性与安全性方面的隐患。
* **改动 CPU 指令集**：即硬件辅助虚拟化（HVM：Hardware-assisted Virtualization Machine），优点是无需改动 Guest OS，兼容 Windows 与 Linux。HVM 已成为数据中心主流虚拟化技术。

#### 1.1.4 Intel VT-x/VT-i 技术
- - -

![](/img/2023-03-19-intel-vt/2023-05-02-figure6.webp)

> 比尔搞不定，安迪来帮忙。（比尔·盖茨是微软公司创始人，安迪·葛洛夫是 Intel 公司创始人）

针对敏感指令引发的一系列虚拟化问题，2005 年 Intel 与 AMD 公司分别推出了 VT-x/VT-i 与 AMD-V，能够在芯片级别支持全虚拟化时，这就是现在称之为的硬件辅助虚拟化技术（HVM：Hardware-assisted Virtualization Machine）。

![](/img/2023-03-19-intel-vt/2023-05-02-figure5.png)

第一代 VT-x 与 AMD-V 都试图通过定义新的运行模式，使 Guest OS 恢复到 Ring 0，而让 VMM 运行在比 Ring 0 低的级别（可以理解为Ring -1）。

VT-x 引入了两种操作模式，统称为 VMX（Virtual Machine eXtension）操作模式：
* 根操作模式（VMX Root Operation）：VMM 运行所处的模式，以下简称根模式。
* 非根操作模式（VMX Non-Root Operation）：客户机运行所处的模式，以下简称非根模式。

Root/Non-Root 操作模式将原有的 CPU 操作区分为 VMM 所在的 Root 操作与 VM 所在的 Non-Root 操作，每个操作都拥有 Ring0-Ring3 的所有指令级别。

在 Intel 公司的 VT-x 解决方案中，运行于非根模式下的 Guest OS 可以像在非虚拟化平台下一样运行于 Ring 0 级别，无论是 Ring 0 发出的特权指令还是 Ring 3 发出的敏感指令都会被陷入到根模式的虚拟层。

### 1.2 内存虚拟化（EPT）
- - -

大型操作系统（比如 Linux）的都是通过虚拟内存进行内存管理，内存虚拟化需要对虚拟内存再进行虚拟化。在讲解内存虚拟化之前，我们先来看一下虚拟内存管理技术，否则内存虚拟化很难看读的下去。

#### 1.2.1 虚拟内存
- - -




#### 1.2.2 内存虚拟化
- - -
内存虚拟化技术包括 EPT（Extended Page Table）技术。

内存虚拟化：EPT

### 1.3 I/O 虚拟化（VT-d、VT-c、SR-IOV、Intel® DDIO）
- - -

I／O 虚拟化技术的代表 VT-d（Intel Virtualization Technology for Directed I／O）。

VT-d/IOMMU、VT-c、SR-IOV、Intel® DDIO

### 1.4 图形虚拟化（Intel® GVT）
- - -

图形虚拟化：Intel® GVT

### 1.5 网络功能虚拟化（DPDK）
- - -

网络功能/安全虚拟化：DPDK

### 1.6 安全功能虚拟化（Intel® QAT）
- - -




## 2. Intel® VT 狭义虚拟化技术
- - -

![](/img/2023-03-19-intel-vt/2023-05-01-figure.png)

### 2.1 VT-x/VT-i
- - -


## 参考
- - -
* [Intel® Virtualization Technology (Intel® VT)](https://www.intel.com/content/www/us/en/virtualization/virtualization-technology/intel-virtualization-technology.html)
* [Intel® Virtualization Technology](https://course.ece.cmu.edu/~ece845/docs/vt-overview-itj06.pdf)
* [CPU硬件辅助虚拟化技术](https://zhuanlan.zhihu.com/p/95288037)
* [Overview of the Intel VT Virtualization Features](https://www.thomas-krenn.com/en/wiki/Overview_of_the_Intel_VT_Virtualization_Features)
* [从半空看虚拟化](http://www.valleytalk.org/wp-content/uploads/2012/05/%E4%BB%8E%E5%8D%8A%E7%A9%BA%E7%9C%8B%E8%99%9A%E6%8B%9F%E5%8C%96.pdf)
* [Cloud Operating Systems](https://www.iaik.tugraz.at/wp-content/uploads/2022/09/slides-6.pdf)
* [NFV关键技术：计算虚拟化概述](https://www.51cto.com/article/666964.html)
* [Intel/AMD virtualization isolation and containment](https://michielkalkman.com/posts/virtualization-cpu-io-isolation-modeling/#intel-cpu-virtualization)
* [NFV关键技术：计算虚拟化之内存虚拟化](https://www.51cto.com/article/696129.html)

## 公众号：Flowlet
- - -

<img src="/img/qrcode_flowlet.jpg" width = 30% height = 30% alt="Flowlet" align=center/>

- - -