---
layout:     post
title:      "微服务时代的 TCP/IP 协议：Service Mesh"
subtitle:   "下一代微服务：Service Mesh"
description: ""
excerpt: ""
date:       2023-04-16 01:01:01
author:     "张帅"
image: "/img/2023-04-16-service-mesh-pattern/backgroud.jpg"
showtoc: true
draft: true
tags:
    - service mesh
categories: [ Tech ]
URL: "/2023/04/16/service-mesh-pattern/"
---

- - -
###### 关于作者
> 
> **`张帅，网络从业人员，公众号：Flowlet`**
> 
> **`个人博客：https://flowlet.net/`**
- - -

## 前言
- - -

2018 年 9 月 1 日，Bilgin Ibryam 在 InfoQ 发表了一篇文章 [Microservices in a Post-Kubernetes Era](https://www.infoq.com/articles/microservices-post-kubernetes/)。

文中虽然没有明确指明“后 Kubernetes 时代的微服务”是什么，但是从文中可以看出作者的观点是：在后 Kubernetes 时代，服务网格（Service Mesh）技术已完全取代了通过使用软件库来实现网络运维的方式。

服务网格（Service Mesh）因此也被成为下一代微服务技术，在聊服务网格（Service Mesh）之前就不得不先提一下微服务 (Microservices)技术。

## 1. 微服务 (Microservices) 
- - -

![]()

在单体架构（monolithic）中，所有的业务进程都运行在一台服务器上。各个业务进程之间紧密耦合，如果一台服务器上的某个业务进程遇到需求峰值，则必须对一台服务器做集群扩展。而且由于各个业务进程紧密耦合，单个业务进程故障会对服务器上的其他业务进程造成故障影响。

在微服务架构 (Microservices)中，则是将每个业务进程作为一项服务运行。这些服务之间使用轻量级 API 通过明确定义的接口进行通信。这些服务围绕业务功能进行构建，每项服务只执行一项特定功能。由于各个服务之间独立运行，因此可以针对各项服务独立进行更新、部署和扩展，以满足客户对不同业务服务的特定功能的需求。

## 2. 服务网格（Service Mesh）
- - -

在本节将会从技术演进的角度阐述一下，Service Mesh 这项技术诞生的历史必然性。


### 2.1 计算机互联畅想时代
- - -

在 Intenet 实现计算机互联之前，最开始人们想象的计算机服务之间的交互方式是这样的：

![]()

一个应用程序通过与另一个应用程序发生对话来完成用户的请求。

### 2.2 ARPANET 时代
- - -

![]()

在 20 世纪 50 年代，那时候计算机很稀有，也很昂贵，计算机之间的互联的需求不大，数据量也很有限。

因此在 TCP/IP 协议出现之前，都是需要应用程序自己来处理网络通信所面临的丢包、乱序、重试等一系列流控问题，因此在应用程序的实现中，除了业务逻辑外，还包含对网络传输问题的处理逻辑。

### 2.2 TCP/IP 时代
- - -

随着计算机变得越来越普及，计算机之间的连接数量和数据量出现了爆炸式的增长。

为了避免每个应用程序都需要自己实现一套相似的网络传输处理逻辑，将应用程序中通用的路由传输与流量控制逻辑抽离出来，并形成 TCP/IP 这类的协议标准规范，作为操作系统网络层的一部分。

### 2.3 微服务1.0 时代
- - -


在 TCP/IP 协议出现之后，机器之间的网络通信不再是一个难题，以 GFS/BigTable/MapReduce 为代表的分布式系统得以蓬勃发展。这时，分布式系统特有的通信语义又出现了，如熔断策略、负载均衡、服务发现、认证和授权、quota 限制、trace 和监控等等，于是服务根据业务需求来实现一部分所需的通信语义。

服务发现的目的是找到有能力处理请求的服务实例。比如，有个叫作 Teams 的服务需要找到一个叫作 Players 的服务实例。通过调用服务发现，可以获得一个满足条件的服务器清单。对于单体系统来说，这个可以通过 DNS、负载均衡器和端口机制（比如通过 HTTP 服务器的 8080 端口来绑定服务）来实现。而在分布式系统里，事情就复杂了，服务发现需要处理更多的任务，比如客户端负载均衡、多环境（如 staging 环境和生产环境）、分布式服务器的物理位置等。

### 2.4 微服务2.0 时代
- - -



为了避免每个服务都需要自己实现一套分布式系统通信的语义功能，随着技术的发展，一些面向微服务架构的开发框架出现了，如 Twitter 的 Finagle、Facebook 的 Proxygen 以及 Spring Cloud 等等，这些框架实现了分布式系统通信需要的各种通用语义功能：如负载均衡和服务发现等，因此一定程度上屏蔽了这些通信细节，使得开发人员使用较少的框架代码就能开发出健壮的分布式系统。


### 2.5 Service Mesh 1.0 时代
- - -

第二代微服务模式看似完美，但开发人员很快又发现，它也存在一些本质问题：

其一，虽然框架本身屏蔽了分布式系统通信的一些通用功能实现细节，但开发者却要花更多精力去掌握和管理复杂的框架本身，在实际应用中，去追踪和解决框架出现的问题也绝非易事；
其二，开发框架通常只支持一种或几种特定的语言，回过头来看文章最开始对微服务的定义，一个重要的特性就是语言无关，但那些没有框架支持的语言编写的服务，很难融入面向微服务的架构体系，想因地制宜的用多种语言实现架构体系中的不同模块也很难做到；
其三，框架以lib库的形式和服务联编，复杂项目依赖时的库版本兼容问题非常棘手，同时，框架库的升级也无法对服务透明，服务会因为和业务无关的lib库升级而被迫升级；

因此以 Linkerd，Envoy，Nginx Mesh 为代表的代理模式（边车模式）应运而生，这就是第一代 Service Mesh，它将分布式服务的通信抽象为单独一层，在这一层中实现负载均衡、服务发现、认证授权、监控追踪、流量控制等分布式系统所需要的功能，作为一个和服务对等的代理服务，和服务部署在一起，接管服务的流量，通过代理之间的通信间接完成服务之间的通信请求，这样上边所说的三个问题也迎刃而解。

如果我们从一个全局视角来看，就会得到如下部署图：
![]()

如果我们暂时略去服务，只看Service Mesh的单机组件组成的网络：
![]()

相信现在，大家已经理解何所谓Service Mesh，也就是服务网格了。它看起来确实就像是一个由若干服务代理所组成的错综复杂的网格。

### 2.6 Service Mesh 2.0 时代
- - -


第一代 Service Mesh 由一系列独立运行的单机代理服务构成，为了提供统一的上层运维入口，演化出了集中式的控制面板，所有的单机代理组件通过和控制面板交互进行网络拓扑策略的更新和单机数据的汇报。这就是以 Istio 为代表的第二代 Service Mesh。


只看单机代理组件(数据面板)和控制面板的 Service Mesh 全局部署视图如下：



## 3. 服务网格（Service Mesh）后续演进
- - -

自 2017 年以来，进入 Facebook 数据中心的所有流量均要经过 eBPF，而谷歌的大部分流量也是如此。实际上，如今有大量的公司正在生产环境中使用 eBPF。
eBPF 已经成为了内核网络的新标准，因为它带来了超强的能力，使网络能够动态增加新的特性，并支持扩展以满足用户的需求。

服务网格就相当于现在分布式计算中的动态链接器。在传统的编程中，要包含另外一个模块，将会涉及到将一个库导入到 IDE 中，在部署时，操作系统的动态链接器在运行时会将我们的程序与这个库连接在一起。链接器还会处理库发现、安全验证和建立连接等问题。

在云原生环境中，我们如今的“库”就是一个对其他微服务的网络跳转。寻找“库”并建立安全连接就是服务网格的问题。与之类似，对于动态链接器，只有一份库的副本，对于服务网格，每个节点只有一个 Envoy 或 eBPF 程序。对开发或运维团队来说，考虑动态链接器是没有太大意义的，那么他们为何要关心复杂的服务网格呢？

Istio 最近还推出了Ambient Mesh，这是一个无 sidecar 的服务网格，目的是减少 sidecar 造成的运维复杂性、资源利用率低和流量中断。Ambient Mesh 将 L7 的处理转移到每个命名空间的“waypoint proxy”，并尽可能利用第 4 层处理。这会将“服务网格功能”转移到更低的网络层，只有在其他方式不可行的情况下，才会依赖服务网格。将服务网格添加到网络中减少了资源和运维的开销。



服务网格是为了解决云原生领域的网络问题而创建的，但是正如前文所述，它也有自己的问题。我们想要的是两全其美的效果，“传统网络”为我们提供第 3-4 层的可观测性、上下文和控制，服务网格则处理第 7 层的 API 通信。

幸运的是，我们已经看到这两个层正在逐渐走到一起，而且随着 eBPF 的出现，这种趋势只会加速实现。如果将服务网格连接至网络中，那么我们就能够在所有的网络层上拥有完整的上下文和控制，并改善环境搭建、运维和问题排查。



随着服务网格成为网络的一部分，合并后的优势主要体现在标准化、集成和运维方面。



首先，我们可以通过将服务网格和网络结合在一起，实现标准化和跨层的传播上下文。在 Kubernetes 中，通过 Gateway API，我们可以看到这一点正在变成现实。OCI 为容器运行时提供了一个标准，并能根据需要互换容器运行时，与之类似，Gateway API 提供了一个标准的方式来实现 Kubernetes 中的网络。标准化允许消费者为自己选择最好的实现方式，在这种情况下，将网络和服务网格结合到一个连接层将会更加容易。



其次，一旦实现标准化，一个集成的生态系统就可以开始成长起来。对于增加新的或额外的特性，生态系统是一种很好的方式，因为它们提供了一致的集成点。更重要的是，标准化会推进与传统工作负载环境的集成，特别是与网络的集成。根据我们与客户合作的经验，企业会需要企业级的网络。这意味着，除了简单的 HTTP 请求之外，还需要额外的协议和复杂的网络拓扑结构。能够集成到这些具有不同要求的环境中，是确保服务网格在未来的网络中还能长足发展的重要原因。



最后，没有人喜欢调试网络。为什么要将它分为两个独立的层，而且在出错时，这两个层以及它们之间的接口都需要进行调试呢？将服务网格与网络结合起来，这会使得运行、运维和调试都更加容易，因为所有的上下文和问题都在同一个地方，而不是泄露到其他抽象层中。我认为，我们可以确信地说，平台连接的管理和运维将会完全由平台和网络团队负责。在网络连接的每一层都能讲述一个完整的连接故事，这对于网络和服务网格未来的组合将会至关重要。



虽然关于组合网络和服务网格的最佳实施方案依然还在争论中，但是当它实现后，将会有许多令人兴奋的机会出现在我们面前。使用 OCI 将容器标准化之后，我们就可以创建新的运行时、将容器添加到注册中心以供发现，并且能够在生产环境中编排它们。今天，运行容器并没有什么特别之处，仅仅是计算的一部分而已。



我期待同样的事情也能发生在服务网格上。它是网络的另一个组成部分，使我们能够为微服务、应用程序和工作负载提供从第 1 层到第 7 层的完整连接，它只需完成自己的工作就可以。作为网络的一部分，服务网格会有一个光明的未来，尽可能远离开发人员的视线和思维，这是一件好事儿。



本文翻译自[Pattern: Service Mesh](https://philcalcado.com/2017/08/03/pattern_service_mesh.html)。

本文为译者根据原文意译，非逐词逐句翻译。由于译者水平有限，本文不免存在遗漏或错误之处。如有疑问，请查阅原文。

## 参考
- - -
* [Pattern: Service Mesh](https://philcalcado.com/2017/08/03/pattern_service_mesh.html)
* [](https://blog.csdn.net/w2009211777/article/details/123840631)
* [](https://www.infoq.cn/article/pattern-service-mesh)
* [](https://www.infoq.cn/article/nquw3jfptyvbbryp1grv)
* [](https://www.infoq.cn/article/tjhrjra2ljje5irdbrrg)
* [](https://zhuanlan.zhihu.com/p/61901608)
* [](https://www.infoq.cn/article/xVEoHtcORtxRSpCf2Ldd)
* [](https://baijiahao.baidu.com/s?id=1673447780783281116&wfr=spider&for=pc)
* [](https://doc.cncf.vip/istio-handbook/gai-nian-yuan-li/service-mesh-architectures/service-mesh-patterns)
* [](http://blog.itpub.net/69953029/viewspace-2923312/)
* [](https://www.apiseven.com/blog/what-is-service-mesh)
* [The Future of Service Mesh is Networking](https://www.infoq.com/articles/service-mesh-networking/)
* [Microservices in a Post-Kubernetes Era](https://www.infoq.com/articles/microservices-post-kubernetes/)
* [microservices](https://aws.amazon.com/cn/microservices/)
* [](https://hanamichi.wiki/posts/service-mesh2/)

## 公众号：Flowlet
- - -

<img src="/img/qrcode_flowlet.jpg" width = 30% height = 30% alt="Flowlet" align=center/>

- - -