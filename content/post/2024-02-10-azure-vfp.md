---
layout:     post
title:      "VFP：公有云主机 SDN 的虚拟交换平台 [NSDI'17]"
subtitle:   "公有云主机 SDN 的虚拟交换平台"
description: "VFP: A Virtual Switch Platform for Host SDN in the Public Cloud"
excerpt: ""
date:       2024-02-10 01:01:01
author:     "张帅"
image: "/img/2024-02-10-azure-vfp/background.jpg"
showtoc: true
draft: true
tags:
    - vSwitch
categories: [ Tech ]
URL: "/2024/02/10/azure-vfp/"
---

- - -
###### 关于作者
> 
> **`张帅，网络从业人员，公众号：Flowlet`**
> 
> **`个人博客：https://flowlet.net/`**
- - -

## 序言
- - -

公有云的 Host vSwitch 由于涉及的业务场景复杂（几乎所有的业务场景都跟 vSwitch 有关，例如：VPC、Nat、EIP、LB、NFV、容器场景等等），配置变更频繁，性能要求极高。同时由于国内公有云业务极其内卷，Iaas 服务基本上就是比拼价格，事实上已经沦为卖铁。VM 超卖严重，分配给 Host 用于网络处理的 CPU 与内存资源极其有限。

Host vSwitch 的设计就如同带着镣铐跳舞，基于开源的 Open vSwitch 不能满足超大规模云网络的技术指标（单 Region 支持百万级 VPC，单 VPC 支持百万级计算节点）要求，因此国内的 Top 级互联网云厂商 Host vSwitch 都采用了自研架构。从 0 到 1 设计 vSwitch 需要熟悉所有的公有云网络业务场景，并且需要极强的技术功底与网络架构能力。

本文翻译自 NSDI'17 论文《[VFP: A Virtual Switch Platform for Host SDN in the Public Cloud](https://www.usenix.org/system/files/conference/nsdi17/nsdi17-firestone.pdf)》，该文章介绍了微软 Azure 在设计 Host vSwitch（VFP：Virtual Filtering Platform）方面的经验。

## 前言
- - -

由于译者水平有限，本文不免存在遗漏或错误之处。如有疑问，请查阅原文。

## 摘要
- - -

许多现代可扩展云网络架构都依赖主机网络来实施 VM 网络策略 ———— 例如，用于虚拟网络的隧道、用于负载均衡的 NAT、带状态的 ACL、QoS 等。我们推出虚拟过滤平台 (VFP：Virtual Filtering Platform) ———— 为 Microsoft Azure（大型公共云）提供该网络策略支持的一种可编程虚拟交换机。根据我们的运营经验我们为可编程虚拟交换机定下了以下几个主要目标，包括支持多个独立的网络控制器、基于连接而不是仅仅基于数据包的网络策略、通过高效缓存和分类算法来提高性能以及将流策略高效的卸载到可编程 NIC，并演示 VFP 是如何实现这些目标的。VFP 已部署在超过 100 万台运行 IaaS 和 PaaS 工作负载的主机上超过 4 年。我们将介绍 VFP 及其 API 设计、用于流处理的流语言和编译器、性能结果以及多年来在 Azure 中部署和使用 VFP 的经验。

## 1. 介绍
- - -

Amazon Web Services、Microsoft Azure 和 Google Cloud Platform [13-15] 等公共云工作负载的兴起创造了数据中心计算的新规模，供应商定期报告服务器数量达到数百万台。这些供应商不仅必须为客户提供虚拟机 (VM) 的规模和高密度/性能，还必须提供丰富的网络语义，例如具有客户提供的地址空间的专用虚拟网络、可扩展的 L4 负载均衡器、安全组和 ACL 、虚拟路由表、带宽计量、QoS 等等。

该策略非常复杂，通常无法在传统核心路由器和硬件中经济地大规模实施。相反，一种常见的方法是在虚拟机主机上的软件中、在将虚拟机连接到网络的虚拟交换机 (vswitch) 中实施此策略，该策略可以根据服务器数量很好地扩展，并允许物理网络变得简单、可扩展且易于使用。非常快。由于该模型将集中式控制平面与主机上的数据平面分开，因此它被广泛认为是软件定义网络 (SDN) 的一个示例，特别是基于主机的 SDN。

作为大型公共云提供商，Azure 在基于主机的 SDN 技术上构建了其云网络，使用它们来实现我们提供的几乎所有虚拟网络功能。大部分关注点都集中在 SDN 上近年来一直致力于构建可扩展且灵活的网络控制器和服务，这一点至关重要。然而，可编程vswitch的设计同样重要。它具有高度可编程数据平面的双重且经常相互冲突的要求，具有高性能和低开销，因为云工作负载对成本和性能敏感。

在本文中，我们介绍了虚拟过滤平台（VFP）——我们在所有主机上运行的云级虚拟交换机。 VFP 之所以如此命名，是因为它充当 VM 的每个虚拟 NIC 的过滤引擎，允许控制器对其 SDN 策略进行编程。我们的目标是展示我们的设计和大规模生产中运行 VFP 的经验，以及我们学到的经验教训。

### 1.1 相关工作
- - -

在本文中，我们使用了文献中的两个激励性示例，并展示了 VFP 如何支持他们的政策和行动。第一个是 VL2 [2]，它可用于使用主机之间的无状态隧道在共享硬件上创建虚拟网络 (VNET)。第二个是 Ananta [4]，一个可扩展的第 4 层负载均衡器，它通过在终端主机上的 vswitch 中运行负载均衡 NAT 来进行扩展，使网络内负载均衡器保持无状态且可扩展。

此外，我们还对可编程转发平面协议 OpenFlow [5] 和实现 OpenFlow 的流行开源 vswitch OpenVswitch [1] (OVS) 进行了参考和比较。这是 SDN 领域的两个开创性项目。我们从公共云的角度指出了核心设计差异，即我们的约束与开源项目的约束有何不同。我们的目标是与更广泛的社区分享这些经验教训。

## 2. 设计目标
- - -

## 3. 概述
- - -

## 4. 过滤模型
- - -

## 5. 编程模型
- - -

## 6. 报文处理与流编译器
- - -

## 7. 交换模型
- - -

## 8. 注意事项
- - -

## 9. 硬件 Offload 与性能
- - -

## 10. 经验
- - -

## 11. 结论与未来工作
- - -


## 参考
- - -
* [VFP: A Virtual Switch Platform for Host SDN in the Public Cloud](https://www.usenix.org/system/files/conference/nsdi17/nsdi17-firestone.pdf)

## 公众号：Flowlet
- - -

<img src="/img/qrcode_flowlet.jpg" width = 30% height = 30% alt="Flowlet" align=center/>

- - -